<!DOCTYPE html> 
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול אירועי בר מצווה</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Netlify Identity -->
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <!-- Auth0 -->
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    <!-- Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    
    <!-- PWA Manifest -->
    <link rel="manifest" id="manifest">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="בר מצווה מנהל">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%231e3a8a'/><text y='50' x='50' text-anchor='middle' dominant-baseline='middle' font-size='40' fill='white'>🎵</text></svg>">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e3a8a',
                        secondary: '#374151',
                        accent: '#059669'
                    },
                    fontFamily: {
                        'rounded': ['ui-rounded', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Varela+Round&family=Nunito:wght@300;400;500;600;700;800&display=swap');
        body { 
            font-family: 'Nunito', 'Varela Round', sans-serif; 
            font-weight: 500;
        }
        .gradient-header { background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%); }
        .card-professional { 
            transition: all 0.3s ease; 
            border-left: 4px solid transparent;
        }
        .card-professional:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
            border-left-color: #1e3a8a;
        }
        .card-gradient-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-gradient-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .card-gradient-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .card-gradient-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .card-gradient-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .card-gradient-6 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .sidebar {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .song-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-left: 4px solid #3b82f6;
        }
        .song-card:nth-child(even) {
            background: linear-gradient(135deg, #fef7ff 0%, #f3e8ff 100%);
            border-left-color: #8b5cf6;
        }
        .song-card:nth-child(3n) {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-left-color: #10b981;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Sidebar -->
    <div id="sidebar" class="sidebar fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-50 overflow-y-auto">
        <div class="p-6 border-b border-gray-200 bg-gradient-to-l from-blue-600 to-purple-600 text-white">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">תפריט ניהול</h2>
                <button id="closeSidebar" class="text-white hover:text-gray-200 text-2xl font-bold p-2 rounded-full hover:bg-white hover:bg-opacity-20 transition-all">
                    ×
                </button>
            </div>
        </div>
        
        <!-- Login Section -->
        <div class="p-4 border-b border-gray-200">
            <div id="loginSection">
                <button id="loginBtn" class="w-full bg-blue-600 text-white px-3 py-2 rounded-2xl text-sm font-medium hover:bg-blue-700 transition-colors shadow-md flex items-center justify-center">
                    <span class="ml-2">🔐</span>
                    <span>כניסה למנהל</span>
                </button>
            </div>
            <div id="userInfo" class="hidden">
                <div class="bg-green-50 p-4 rounded-2xl border border-green-200">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <div class="text-green-800 font-medium">מנהל המערכת</div>
                            <div class="text-green-600 text-sm">גישה מלאה</div>
                        </div>
                        <span class="text-green-500 text-2xl">✅</span>
                    </div>
                    <div class="space-y-2">
                        <button id="editContentBtn" class="w-full bg-purple-600 text-white px-4 py-2 rounded-2xl text-sm hover:bg-purple-700 transition-colors">
                            ✏️ עריכת תוכן
                        </button>
                        <button onclick="refreshDataFromCMS()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-2xl text-sm hover:bg-blue-700 transition-colors">
                            🔄 רענן נתונים
                        </button>
                        <button onclick="exportToCMSFormat()" class="w-full bg-green-600 text-white px-4 py-2 rounded-2xl text-sm hover:bg-green-700 transition-colors">
                            📥 ייצא נתונים
                        </button>
                        <div class="mt-3 p-2 bg-yellow-50 rounded-2xl border border-yellow-200">
                            <div class="text-xs text-yellow-700 font-medium">💾 שמירה אוטומטית</div>
                            <div class="text-xs text-yellow-600">כל השינויים נשמרים אוטומטית ל-CMS</div>
                        </div>
                        <button id="logoutBtn" class="w-full bg-red-600 text-white px-4 py-2 rounded-2xl text-sm hover:bg-red-700 transition-colors">
                            יציאה
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <nav class="p-4">
            <ul class="space-y-2">
                <li>
                    <button onclick="showPage('events')" class="nav-item w-full text-right p-4 rounded-2xl hover:bg-blue-50 transition-all flex items-center">
                        <span class="text-blue-500 ml-3 text-xl">📅</span>
                        <span class="font-medium">אירועים</span>
                    </button>
                </li>
                <li>
                    <button onclick="showPage('prayer-songs')" class="nav-item w-full text-right p-4 rounded-2xl hover:bg-purple-50 transition-all flex items-center">
                        <span class="text-purple-500 ml-3 text-xl">🎵</span>
                        <span class="font-medium">שירי תפילה</span>
                    </button>
                </li>
                <li>
                    <button onclick="showPage('meal-songs')" class="nav-item w-full text-right p-4 rounded-2xl hover:bg-green-50 transition-all flex items-center">
                        <span class="text-green-500 ml-3 text-xl">🍽️</span>
                        <span class="font-medium">שירי סעודה</span>
                    </button>
                </li>
                <li id="adminSection" class="border-t border-gray-200 pt-4 mt-4 hidden">
                    <div class="text-gray-500 text-sm font-medium mb-2 px-4">אזור אישי</div>
                    <button onclick="showPage('admin')" class="nav-item w-full text-right p-4 rounded-2xl hover:bg-orange-50 transition-all flex items-center">
                        <span class="text-orange-500 ml-3 text-xl">👤</span>
                        <span class="font-medium">ניהול תלמידים</span>
                    </button>
                </li>
                <li id="equipmentSection" class="hidden">
                    <button onclick="showPage('equipment')" class="nav-item w-full text-right p-4 rounded-2xl hover:bg-red-50 transition-all flex items-center">
                        <span class="text-red-500 ml-3 text-xl">🎤</span>
                        <span class="font-medium">צ'קליסט ציוד</span>
                    </button>
                </li>
                <li id="paymentsSection" class="hidden">
                    <button onclick="showPage('payments')" class="nav-item w-full text-right p-4 rounded-2xl hover:bg-emerald-50 transition-all flex items-center">
                        <span class="text-emerald-500 ml-3 text-xl">💰</span>
                        <span class="font-medium">מעקב תשלומים</span>
                    </button>
                </li>
                <li id="songsLibrarySection" class="hidden">
                    <button onclick="showPage('songs-library')" class="nav-item w-full text-right p-4 rounded-2xl hover:bg-indigo-50 transition-all flex items-center">
                        <span class="text-indigo-500 ml-3 text-xl">🎼</span>
                        <span class="font-medium">ספריית שירים</span>
                    </button>
                </li>
                <li id="importantLinksSection" class="hidden">
                    <button onclick="showPage('important-links')" class="nav-item w-full text-right p-4 rounded-2xl hover:bg-cyan-50 transition-all flex items-center">
                        <span class="text-cyan-500 ml-3 text-xl">🔗</span>
                        <span class="font-medium">קישורים חשובים</span>
                    </button>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Overlay -->
    <div id="overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40" onclick="closeSidebar()"></div>

    <!-- Header -->
    <header class="gradient-header text-white shadow-lg">
        <div class="container mx-auto px-4 sm:px-6 py-4 sm:py-6">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
                <div class="mb-4 sm:mb-0">
                    <h1 class="text-2xl sm:text-3xl font-bold mb-1">מערכת ניהול אירועי בר מצווה</h1>
                    <p class="text-blue-100 text-sm sm:text-lg">ניהול תפילה • לימוד • שירים ופיוטים</p>
                </div>
                <div class="flex items-center space-x-3 space-x-reverse">
                    <button id="installApp" class="bg-green-600 text-white px-4 py-2 rounded-2xl hover:bg-green-700 transition-all flex items-center hidden">
                        <span class="ml-2">📱</span>
                        <span>התקן אפליקציה</span>
                    </button>
                    <button id="menuBtn" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-2xl hover:bg-opacity-30 transition-all flex items-center">
                        <span class="ml-2">☰</span>
                        <span>תפריט</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 py-6 sm:py-8">
        <!-- Events Page -->
        <div id="events-page" class="page">
            <div class="bg-white rounded-3xl shadow-lg border border-gray-100">
                <div class="bg-gradient-to-l from-blue-50 to-indigo-50 border-b border-gray-200 p-4 sm:p-6 rounded-t-3xl">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
                        <div class="mb-4 sm:mb-0">
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1">אירועים קרובים</h2>
                            <p class="text-gray-600 text-sm sm:text-base">זמני הגעת האורחים וזמני תחילת האירוע</p>
                        </div>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 sm:space-x-reverse">
                            <select id="packageFilter" class="border border-gray-300 rounded-2xl px-3 sm:px-4 py-2 text-gray-700 bg-white shadow-sm text-sm sm:text-base">
                                <option value="">כל החבילות</option>
                                <option value="חבילה בסיסית">חבילה בסיסית</option>
                                <option value="חבילה חגיגית">חבילה חגיגית</option>
                                <option value="חבילת הכל כלול">חבילת הכל כלול</option>
                            </select>
                            <select id="keyboardistFilter" class="border border-gray-300 rounded-2xl px-3 sm:px-4 py-2 text-gray-700 bg-white shadow-sm text-sm sm:text-base">
                                <option value="">כל האירועים</option>
                                <option value="true">עם קלידן</option>
                                <option value="false">ללא קלידן</option>
                            </select>
                            <select id="drummersFilter" class="border border-gray-300 rounded-2xl px-3 sm:px-4 py-2 text-gray-700 bg-white shadow-sm text-sm sm:text-base">
                                <option value="">כל האירועים</option>
                                <option value="true">עם מתופפים</option>
                                <option value="false">ללא מתופפים</option>
                            </select>
                            <button id="addEventBtn" class="bg-blue-600 text-white px-4 sm:px-6 py-2 rounded-2xl hover:bg-blue-700 transition-colors font-medium shadow-md text-sm sm:text-base hidden" onclick="addNewEvent()">
                                ➕ הוסף אירוע
                            </button>
                        </div>
                    </div>
                </div>

                <div class="p-4 sm:p-6 space-y-4 sm:space-y-6" id="eventsContainer">
                    <!-- Event items will be populated here -->
                </div>
            </div>
        </div>

        <!-- Prayer Songs Page -->
        <div id="prayer-songs-page" class="page hidden">
            <div class="bg-white rounded-3xl shadow-lg border border-gray-100">
                <div class="bg-gradient-to-l from-purple-50 to-pink-50 border-b border-gray-200 p-4 sm:p-6 rounded-t-3xl">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1">שירי תפילה</h2>
                    <p class="text-gray-600 text-sm sm:text-base">רשימת השירים לחלק התפילה בבר המצווה</p>
                </div>
                <div class="p-4 sm:p-6 space-y-4" id="prayerSongsContainer">
                    <!-- Prayer songs will be populated here -->
                </div>
            </div>
        </div>

        <!-- Meal Songs Page -->
        <div id="meal-songs-page" class="page hidden">
            <div class="bg-white rounded-3xl shadow-lg border border-gray-100">
                <div class="bg-gradient-to-l from-green-50 to-emerald-50 border-b border-gray-200 p-4 sm:p-6 rounded-t-3xl">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1">שירי סעודה</h2>
                    <p class="text-gray-600 text-sm sm:text-base">רשימת השירים לחלק הסעודה בבר המצווה</p>
                </div>
                <div class="p-4 sm:p-6 space-y-4" id="mealSongsContainer">
                    <!-- Meal songs will be populated here -->
                </div>
            </div>
        </div>

        <!-- Admin Page -->
        <div id="admin-page" class="page hidden">
            <div class="bg-white rounded-3xl shadow-lg border border-gray-100">
                <div class="bg-gradient-to-l from-orange-50 to-red-50 border-b border-gray-200 p-4 sm:p-6 rounded-t-3xl">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1">ניהול תלמידים</h2>
                    <p class="text-gray-600 text-sm sm:text-base">מעקב אחר התקדמות התלמידים</p>
                </div>
                <div class="divide-y divide-gray-200" id="studentsContainer">
                    <!-- Student items will be populated here -->
                </div>
            </div>
        </div>

        <!-- Equipment Page -->
        <div id="equipment-page" class="page hidden">
            <div class="bg-white rounded-3xl shadow-lg border border-gray-100">
                <div class="bg-gradient-to-l from-red-50 to-pink-50 border-b border-gray-200 p-4 sm:p-6 rounded-t-3xl">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1">צ'קליסט ציוד</h2>
                    <p class="text-gray-600 text-sm sm:text-base">רשימת ציוד נדרש לאירוע</p>
                </div>
                <div class="p-4 sm:p-6" id="equipmentContainer">
                    <!-- Equipment checklist will be populated here -->
                </div>
            </div>
        </div>

        <!-- Payments Page -->
        <div id="payments-page" class="page hidden">
            <div class="bg-white rounded-3xl shadow-lg border border-gray-100">
                <div class="bg-gradient-to-l from-emerald-50 to-teal-50 border-b border-gray-200 p-4 sm:p-6 rounded-t-3xl">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1">מעקב תשלומים</h2>
                    <p class="text-gray-600 text-sm sm:text-base">מעקב אחר תשלומים לקלידן, מתופפים וקבלות</p>
                </div>
                <div class="p-4 sm:p-6" id="paymentsContainer">
                    <!-- Payments tracking will be populated here -->
                </div>
            </div>
        </div>

        <!-- Songs Library Page -->
        <div id="songs-library-page" class="page hidden">
            <div class="bg-white rounded-3xl shadow-lg border border-gray-100">
                <div class="bg-gradient-to-l from-indigo-50 to-purple-50 border-b border-gray-200 p-4 sm:p-6 rounded-t-3xl">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
                        <div class="mb-4 sm:mb-0">
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1">ספריית שירים</h2>
                            <p class="text-gray-600 text-sm sm:text-base">כל השירים והפיוטים במערכת</p>
                        </div>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 sm:space-x-reverse">
                            <input type="text" id="songSearch" placeholder="חיפוש שיר..." class="border border-gray-300 rounded-2xl px-3 sm:px-4 py-2 text-gray-700 bg-white shadow-sm text-sm sm:text-base">
                            <button id="toggleCategoriesBtn" onclick="toggleCategories()" class="bg-purple-600 text-white px-4 sm:px-6 py-2 rounded-2xl hover:bg-purple-700 transition-colors font-medium shadow-md text-sm sm:text-base">
                                📂 הצג קטגוריות
                            </button>
                            <button id="manageCategoriesBtn" class="bg-orange-600 text-white px-4 sm:px-6 py-2 rounded-2xl hover:bg-orange-700 transition-colors font-medium shadow-md text-sm sm:text-base hidden" onclick="manageCategories()">
                                🏷️ נהל קטגוריות
                            </button>
                            <button id="addSongBtn" class="bg-blue-600 text-white px-4 sm:px-6 py-2 rounded-2xl hover:bg-blue-700 transition-colors font-medium shadow-md text-sm sm:text-base hidden" onclick="addNewSong()">
                                ➕ הוסף שיר
                            </button>
                        </div>
                    </div>
                </div>
                <div class="p-4 sm:p-6" id="songsLibraryContainer">
                    <!-- Songs library will be populated here -->
                </div>
            </div>
        </div>

        <!-- Important Links Page -->
        <div id="important-links-page" class="page hidden">
            <div class="bg-white rounded-3xl shadow-lg border border-gray-100">
                <div class="bg-gradient-to-l from-cyan-50 to-blue-50 border-b border-gray-200 p-4 sm:p-6 rounded-t-3xl">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
                        <div class="mb-4 sm:mb-0">
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1">קישורים חשובים</h2>
                            <p class="text-gray-600 text-sm sm:text-base">קישורים מהירים לביצוע פעולות נפוצות</p>
                        </div>
                        <button id="addLinkBtn" class="bg-cyan-600 text-white px-4 sm:px-6 py-2 rounded-2xl hover:bg-cyan-700 transition-colors font-medium shadow-md text-sm sm:text-base" onclick="addNewLink()">
                            ➕ הוסף קישור
                        </button>
                    </div>
                </div>
                <div class="p-4 sm:p-6" id="importantLinksContainer">
                    <!-- Important links will be populated here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Event Modal -->
    <div id="eventModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4">
        <div class="bg-white rounded-3xl shadow-xl max-w-4xl w-full max-h-[95vh] sm:max-h-[90vh] overflow-y-auto">
            <div class="border-b border-gray-200 p-3 sm:p-6 sticky top-0 bg-white rounded-t-3xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-base sm:text-lg md:text-xl font-bold text-gray-800" id="modalTitle">פרטי אירוע</h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 text-xl sm:text-2xl font-bold p-1 rounded-full hover:bg-gray-100 transition-all">×</button>
                </div>
            </div>
            <div class="p-3 sm:p-6" id="modalContent">
                <!-- Modal content will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Sample data
        const events = [
            {
                id: 1,
                name: "דוד כהן",
                date: "2024-01-15",
                time: "10:00",
                guestArrivalTime: "09:30",
                eventStartTime: "10:00",
                location: "בית כנסת הגדול, תל אביב",
                wazeLink: "https://waze.com/ul?q=בית כנסת הגדול תל אביב",
                package: "חבילה חגיגית",
                keyboardist: true,
                drummers: 1,
                isStudent: true,
                price: 3500,
                parentPhone: "050-1234567",
                parentName: "משה כהן",
                notes: "נער מוכשר, מעדיף שירים מזרחיים",
                status: "confirmed",
                mediaLinks: {
                    photos: "https://photos.google.com/share/example1",
                    videos: "https://drive.google.com/folder/example1"
                }
            },
            {
                id: 2,
                name: "יוסי לוי",
                date: "2024-01-18",
                time: "09:30",
                guestArrivalTime: "09:00",
                eventStartTime: "09:30",
                location: "בית כנסת אור החיים, ירושלים",
                wazeLink: "https://waze.com/ul?q=בית כנסת אור החיים ירושלים",
                package: "חבילה בסיסית",
                keyboardist: false,
                drummers: 0,
                isStudent: false,
                price: 2000,
                parentPhone: "052-9876543",
                parentName: "אברהם לוי",
                notes: "משפחה דתית, שירים מסורתיים בלבד",
                status: "confirmed",
                mediaLinks: {
                    photos: "",
                    videos: ""
                }
            },
            {
                id: 3,
                name: "אבי רוזן",
                date: "2024-01-22",
                time: "11:00",
                guestArrivalTime: "10:30",
                eventStartTime: "11:00",
                location: "אולם אירועים דיאמונד, חיפה",
                wazeLink: "https://waze.com/ul?q=אולם אירועים דיאמונד חיפה",
                package: "חבילת הכל כלול",
                keyboardist: true,
                drummers: 2,
                isStudent: true,
                price: 5500,
                parentPhone: "054-5555555",
                parentName: "דני רוזן",
                notes: "אירוע גדול, 200 מוזמנים",
                status: "pending",
                mediaLinks: {
                    photos: "",
                    videos: ""
                }
            }
        ];

        const students = [
            {
                id: 1,
                name: "דוד כהן",
                eventDate: "2024-01-15",
                lessonsCompleted: 8,
                totalLessons: 12,
                nextLesson: "2024-01-10",
                phone: "050-1234567",
                progress: "מתקדם מצוין, מוכן לקריאה בתורה",
                parsha: "פרשת וירא",
                readingType: "עליית ראשון + מפטיר",
                hasRecording: true,
                recordingNotes: "הקלטה של הפרשה והפטרה",
                haftarah: "מלכים א יח:כ-לט",
                torahPortion: "בראשית כב:א-יט",
                specialNotes: "יודע לקרוא עם טעמים, קול יפה"
            },
            {
                id: 3,
                name: "אבי רוזן",
                eventDate: "2024-01-22",
                lessonsCompleted: 6,
                totalLessons: 15,
                nextLesson: "2024-01-12",
                phone: "054-5555555",
                progress: "צריך עבודה נוספת על הפטרה",
                parsha: "פרשת חיי שרה",
                readingType: "עליית ראשון בלבד",
                hasRecording: false,
                recordingNotes: "עדיין לא מוכן להקלטה",
                haftarah: "מלכים א א:א-לא",
                torahPortion: "בראשית כג:א-כ",
                specialNotes: "קושי בטעמים, צריך תרגול נוסף"
            }
        ];

        const prayerSongs = [
            {
                id: 1,
                name: "שמע ישראל",
                key: "Am",
                tempo: 120,
                transpose: 0,
                chords: "Am - F - C - G",
                lyrics: "שמע ישראל ה' אלוהינו ה' אחד\nברוך שם כבוד מלכותו לעולם ועד",
                category: "תפילה"
            },
            {
                id: 2,
                name: "ברכו",
                key: "Dm",
                tempo: 90,
                transpose: 2,
                chords: "Dm - Bb - F - C",
                lyrics: "ברכו את ה' המבורך\nברוך ה' המבורך לעולם ועד",
                category: "כניסה"
            },
            {
                id: 3,
                name: "יגדל",
                key: "G",
                tempo: 110,
                transpose: -1,
                chords: "G - Em - C - D",
                lyrics: "יגדל אלוהים חי ויש תהלל\nנמצא ואין עת אל מציאותו",
                category: "תפילה"
            },
            {
                id: 4,
                name: "אדון עולם",
                key: "C",
                tempo: 100,
                transpose: 3,
                chords: "C - Am - F - G",
                lyrics: "אדון עולם אשר מלך\nבטרם כל יציר נברא",
                category: "תפילה"
            },
            {
                id: 5,
                name: "לכה דודי",
                key: "Em",
                tempo: 85,
                transpose: 0,
                chords: "Em - C - G - D",
                lyrics: "לכה דודי לקראת כלה\nפני שבת נקבלה",
                category: "כניסה"
            }
        ];

        const mealSongs = [
            {
                id: 1,
                name: "שלום עליכם",
                key: "D",
                tempo: 95,
                transpose: 1,
                chords: "D - A - Bm - G",
                lyrics: "שלום עליכם מלאכי השרת\nמלאכי עליון",
                category: "סעודה"
            },
            {
                id: 2,
                name: "אשת חיל",
                key: "F",
                tempo: 80,
                transpose: -2,
                chords: "F - Dm - Bb - C",
                lyrics: "אשת חיל מי ימצא\nורחוק מפנינים מכרה",
                category: "סעודה"
            },
            {
                id: 3,
                name: "ברכת המזון",
                key: "A",
                tempo: 105,
                transpose: 4,
                chords: "A - F#m - D - E",
                lyrics: "ברוך אתה ה' אלוהינו מלך העולם\nהזן את העולם כולו",
                category: "ברכות"
            },
            {
                id: 4,
                name: "הבדלה",
                key: "Bm",
                tempo: 75,
                transpose: 0,
                chords: "Bm - G - D - A",
                lyrics: "הנה אל ישועתי אבטח ולא אפחד\nכי עזי וזמרת יה ה'",
                category: "הבדלה"
            }
        ];

        const equipment = [
            { id: 1, item: "מיקרופון אלחוטי", checked: false, category: "קול" },
            { id: 2, item: "מערכת הגברה", checked: false, category: "קול" },
            { id: 3, item: "קלידים", checked: false, category: "כלי נגינה" },
            { id: 4, item: "תופים", checked: false, category: "כלי נגינה" },
            { id: 5, item: "כבלים", checked: false, category: "טכני" },
            { id: 6, item: "מתאם חשמל", checked: false, category: "טכני" },
            { id: 7, item: "עמדת תווים", checked: false, category: "אביזרים" },
            { id: 8, item: "כיסא לקלידן", checked: false, category: "אביזרים" },
            { id: 9, item: "מחשב נייד", checked: false, category: "טכני" },
            { id: 10, item: "רמקולים", checked: false, category: "קול" }
        ];

        const payments = [
            { 
                id: 1, 
                eventName: "דוד כהן", 
                keyboardistPaid: true, 
                keyboardistAmount: 800,
                drummersPaid: false, 
                drummersAmount: 0,
                receiptIssued: true, 
                managerPaid: true,
                managerAmount: 1500
            },
            { 
                id: 2, 
                eventName: "יוסי לוי", 
                keyboardistPaid: false, 
                keyboardistAmount: 0,
                drummersPaid: false, 
                drummersAmount: 0,
                receiptIssued: false, 
                managerPaid: false,
                managerAmount: 0
            },
            { 
                id: 3, 
                eventName: "אבי רוזן", 
                keyboardistPaid: true, 
                keyboardistAmount: 1000,
                drummersPaid: true, 
                drummersAmount: 1200,
                receiptIssued: false, 
                managerPaid: true,
                managerAmount: 2000
            }
        ];

        // Important links data
        const importantLinks = [
            {
                id: 1,
                name: "יש חשבונית - הוצאת קבלה",
                url: "https://www.ishhashounit.co.il",
                description: "מערכת להוצאת קבלות ומעקב הכנסות",
                category: "כספים",
                icon: "🧾"
            },
            {
                id: 2,
                name: "יש חשבונית - הזמנה חדשה",
                url: "https://www.ishhashounit.co.il/new-order",
                description: "פתיחת הזמנה חדשה במערכת",
                category: "כספים",
                icon: "📝"
            },
            {
                id: 3,
                name: "Google Calendar",
                url: "https://calendar.google.com",
                description: "ניהול לוח שנה ותזמון אירועים",
                category: "ניהול זמן",
                icon: "📅"
            },
            {
                id: 4,
                name: "WhatsApp Web",
                url: "https://web.whatsapp.com",
                description: "שליחת הודעות ללקוחות",
                category: "תקשורת",
                icon: "📱"
            }
        ];

        // Calendar data
        const lessons = [
            { id: 1, studentName: "דוד כהן", date: "2024-01-10", time: "16:00", duration: 60, type: "lesson", status: "scheduled" },
            { id: 2, studentName: "אבי רוזן", date: "2024-01-12", time: "17:00", duration: 60, type: "lesson", status: "scheduled" },
            { id: 3, studentName: "דוד כהן", date: "2024-01-15", time: "10:00", duration: 180, type: "event", status: "confirmed" }
        ];

        const blockedDates = [
            { date: "2024-01-20", reason: "חופש" },
            { date: "2024-01-25", reason: "אירוע אישי" }
        ];

        // Communication data
        const messageTemplates = [
            { id: 1, name: "תזכורת לשיעור", content: "שלום {name}, תזכורת לשיעור מחר ב-{time}. נתראה!" },
            { id: 2, name: "תזכורת לאירוע", content: "שלום {parentName}, תזכורת לבר המצווה של {studentName} ב-{date} ב-{time}. בהצלחה!" },
            { id: 3, name: "ביטול שיעור", content: "שלום {name}, צר לי אבל אני צריך לבטל את השיעור של {date}. נתאם תאריך חדש." },
            { id: 4, name: "רשימת שירים", content: "שלום {parentName}, מצורפת רשימת השירים לבר המצווה של {studentName}: {songsList}" }
        ];

        const messageHistory = [
            { id: 1, recipient: "דוד כהן", phone: "050-1234567", message: "שלום דוד, תזכורת לשיעור מחר ב-16:00. נתראה!", sent: "2024-01-09 15:30", status: "sent" },
            { id: 2, recipient: "משה כהן (הורה)", phone: "050-1234567", message: "שלום משה, תזכורת לבר המצווה של דוד ב-15/01 ב-10:00. בהצלחה!", sent: "2024-01-14 09:00", status: "delivered" }
        ];

        // Song categories management
        const songCategories = [
            { id: 1, name: 'כניסה', color: 'blue', icon: '🚪' },
            { id: 2, name: 'תפילה', color: 'purple', icon: '🙏' },
            { id: 3, name: 'הוצאת ספר תורה', color: 'amber', icon: '📜' },
            { id: 4, name: 'ברכות', color: 'green', icon: '🤲' },
            { id: 5, name: 'סעודה', color: 'orange', icon: '🍽️' },
            { id: 6, name: 'הבדלה', color: 'indigo', icon: '🕯️' },
            { id: 7, name: 'חתונה', color: 'pink', icon: '💒' },
            { id: 8, name: 'מזמורים', color: 'teal', icon: '📖' },
            { id: 9, name: 'כללי', color: 'gray', icon: '🎵' }
        ];

        // Extended songs library
        const songsLibrary = [
            ...prayerSongs.map(song => ({...song, category: "תפילה"})),
            ...mealSongs.map(song => ({...song, category: "סעודה"})),
            { id: 101, name: "עוד ישמע", key: "Em", tempo: 130, transpose: 0, chords: "Em - C - G - D", lyrics: "עוד ישמע בערי יהודה\nובחוצות ירושלים", category: "חתונה", youtubeLink: "https://youtube.com/watch?v=example1" },
            { id: 102, name: "אם אשכחך", key: "Am", tempo: 85, transpose: 2, chords: "Am - F - C - G", lyrics: "אם אשכחך ירושלים\nתשכח ימיני", category: "מזמורים", youtubeLink: "https://youtube.com/watch?v=example2" },
            { id: 103, name: "הבדלה מלודי", key: "D", tempo: 95, transpose: -1, chords: "D - A - Bm - G", lyrics: "הנה אל ישועתי\nאבטח ולא אפחד", category: "הבדלה", youtubeLink: "https://youtube.com/watch?v=example3" }
        ];

        const playlists = [
            { id: 1, name: "בר מצווה קלאסי", songs: [1, 2, 3, 101], eventType: "בר מצווה", description: "רשימת שירים מסורתית לבר מצווה" },
            { id: 2, name: "שירי שבת", songs: [5, 102, 103], eventType: "שבת", description: "שירים לקבלת שבת ושבת" },
            { id: 3, name: "סעודה חגיגית", songs: [6, 7, 8, 101], eventType: "סעודה", description: "שירים לסעודה חגיגית" }
        ];

        // Unified data structure for Decap CMS
        const systemData = {
            events: events,
            students: students,
            prayerSongs: prayerSongs,
            mealSongs: mealSongs,
            equipment: equipment,
            payments: payments,
            lessons: lessons,
            blockedDates: blockedDates,
            messageTemplates: messageTemplates,
            messageHistory: messageHistory,
            songsLibrary: songsLibrary,
            playlists: playlists,
            songCategories: songCategories,
            importantLinks: importantLinks,
            lastUpdated: new Date().toISOString()
        };

        let isLoggedIn = false;
        let currentPage = 'events';
        let filteredEvents = [...events];
        let showCategories = false;
        let showPrayerCategories = false;
        let showMealCategories = false;

        // Authentication setup
        let auth0Client;
        let currentAuthProvider = null;

        // Initialize Auth0
        async function initAuth0() {
            try {
                auth0Client = await auth0.createAuth0Client({
                    domain: 'dev-xq17rgh1xskeyxfa.us.auth0.com',
                    clientId: 'F4UbYRfwBHLlbkFCHUxu6UYs3dn3z2A4',
                    authorizationParams: {
                        redirect_uri: window.location.origin,
                        scope: 'openid profile email'
                    }
                });
                console.log('Auth0 initialized successfully');
            } catch (error) {
                console.log('Auth0 initialization failed:', error);
                auth0Client = null;
            }
        }

        // DOM Elements
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const editContentBtn = document.getElementById('editContentBtn');
        const userInfo = document.getElementById('userInfo');
        const loginSection = document.getElementById('loginSection');
        const eventsContainer = document.getElementById('eventsContainer');
        const studentsContainer = document.getElementById('studentsContainer');
        const eventModal = document.getElementById('eventModal');
        const closeModal = document.getElementById('closeModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const menuBtn = document.getElementById('menuBtn');
        const sidebar = document.getElementById('sidebar');
        const closeSidebarBtn = document.getElementById('closeSidebar');
        const overlay = document.getElementById('overlay');

        // Filter elements
        const packageFilter = document.getElementById('packageFilter');
        const keyboardistFilter = document.getElementById('keyboardistFilter');
        const drummersFilter = document.getElementById('drummersFilter');

        // Event Listeners
        loginBtn.addEventListener('click', auth0Login);
        logoutBtn.addEventListener('click', logout);
        editContentBtn.addEventListener('click', openDecapCMS);
        closeModal.addEventListener('click', () => eventModal.classList.add('hidden'));
        menuBtn.addEventListener('click', openSidebar);
        closeSidebarBtn.addEventListener('click', closeSidebar);

        // Filter event listeners
        packageFilter.addEventListener('change', applyFilters);
        keyboardistFilter.addEventListener('change', applyFilters);
        drummersFilter.addEventListener('change', applyFilters);

        // Functions
        function login() {
            isLoggedIn = true;
            loginSection.classList.add('hidden');
            userInfo.classList.remove('hidden');
            
            // Show admin sections
            document.getElementById('adminSection').classList.remove('hidden');
            document.getElementById('equipmentSection').classList.remove('hidden');
            document.getElementById('paymentsSection').classList.remove('hidden');
            document.getElementById('songsLibrarySection').classList.remove('hidden');
            document.getElementById('importantLinksSection').classList.remove('hidden');
            
            // Show add event button
            const addEventBtn = document.getElementById('addEventBtn');
            if (addEventBtn) {
                addEventBtn.classList.remove('hidden');
            }
            
            // Show add song button
            const addSongBtn = document.getElementById('addSongBtn');
            if (addSongBtn) {
                addSongBtn.classList.remove('hidden');
            }
            
            // Show manage categories button
            const manageCategoriesBtn = document.getElementById('manageCategoriesBtn');
            if (manageCategoriesBtn) {
                manageCategoriesBtn.classList.remove('hidden');
            }
            
            renderCurrentPage();
        }

        async function auth0Login() {
            try {
                if (auth0Client) {
                    console.log('מתחיל התחברות Auth0...');
                    
                    await auth0Client.loginWithRedirect({
                        authorizationParams: {
                            redirect_uri: window.location.origin,
                            scope: 'openid profile email'
                        }
                    });
                    
                } else {
                    console.log('Auth0 לא זמין - מנסה לאתחל מחדש...');
                    await initAuth0();
                    if (auth0Client) {
                        await auth0Login();
                    } else {
                        console.log('Auth0 לא זמין - מתחבר ללא אימות חיצוני');
                        login();
                        currentAuthProvider = 'local';
                        showNotification('התחברת בהצלחה (מצב מקומי)', 'success');
                    }
                }
            } catch (error) {
                console.error('Auth0 login error:', error);
                console.log('נכשל Auth0 - עובר למצב מקומי');
                
                login();
                currentAuthProvider = 'local';
                showNotification('התחברת בהצלחה (מצב מקומי)', 'info');
            }
        }

        function openDecapCMS() {
            const cmsConfig = {
                backend: {
                    name: 'git-gateway',
                    branch: 'main'
                },
                media_folder: 'static/images',
                public_folder: '/images',
                collections: [
                    {
                        name: 'events',
                        label: 'אירועים',
                        folder: 'content/events',
                        create: true,
                        slug: '{{year}}-{{month}}-{{day}}-{{slug}}',
                        fields: [
                            { label: 'שם בר המצווה', name: 'name', widget: 'string' },
                            { label: 'תאריך', name: 'date', widget: 'datetime' },
                            { label: 'מיקום', name: 'location', widget: 'string' },
                            { label: 'חבילה', name: 'package', widget: 'select', options: ['חבילה בסיסית', 'חבילה חגיגית', 'חבילת הכל כלול'] },
                            { label: 'קלידן', name: 'keyboardist', widget: 'boolean', default: false },
                            { label: 'מספר מתופפים', name: 'drummers', widget: 'number', default: 0 },
                            { label: 'מחיר', name: 'price', widget: 'number' },
                            { label: 'שם ההורה', name: 'parentName', widget: 'string' },
                            { label: 'טלפון', name: 'parentPhone', widget: 'string' },
                            { label: 'הערות', name: 'notes', widget: 'text', required: false }
                        ]
                    }
                ]
            };

            if (window.CMS) {
                window.CMS.init({ config: cmsConfig });
                window.open('/admin/', '_blank');
            } else {
                alert('Decap CMS לא זמין. אנא בדוק את ההגדרות.');
            }
        }

        async function logout() {
            try {
                if (currentAuthProvider === 'auth0' && auth0Client) {
                    await auth0Client.logout({
                        logoutParams: {
                            returnTo: window.location.origin
                        }
                    });
                } else {
                    performLogout();
                }
            } catch (error) {
                console.error('Logout error:', error);
                performLogout();
            }
        }

        function performLogout() {
            isLoggedIn = false;
            loginSection.classList.remove('hidden');
            userInfo.classList.add('hidden');
            currentAuthProvider = null;
            
            document.getElementById('adminSection').classList.add('hidden');
            document.getElementById('equipmentSection').classList.add('hidden');
            document.getElementById('paymentsSection').classList.add('hidden');
            document.getElementById('songsLibrarySection').classList.add('hidden');
            document.getElementById('importantLinksSection').classList.add('hidden');
            
            const addEventBtn = document.getElementById('addEventBtn');
            if (addEventBtn) {
                addEventBtn.classList.add('hidden');
            }
            
            const addSongBtn = document.getElementById('addSongBtn');
            if (addSongBtn) {
                addSongBtn.classList.add('hidden');
            }
            
            const manageCategoriesBtn = document.getElementById('manageCategoriesBtn');
            if (manageCategoriesBtn) {
                manageCategoriesBtn.classList.add('hidden');
            }
            
            renderCurrentPage();
        }

        function openSidebar() {
            sidebar.classList.add('open');
            overlay.classList.remove('hidden');
        }

        function closeSidebar() {
            sidebar.classList.remove('open');
            overlay.classList.add('hidden');
        }

        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(page + '-page').classList.remove('hidden');
            
            currentPage = page;
            renderCurrentPage();
            closeSidebar();
        }

        function renderCurrentPage() {
            switch(currentPage) {
                case 'events':
                    renderEvents();
                    break;
                case 'prayer-songs':
                    renderPrayerSongs();
                    break;
                case 'meal-songs':
                    renderMealSongs();
                    break;
                case 'admin':
                    if (isLoggedIn) renderStudents();
                    break;
                case 'equipment':
                    if (isLoggedIn) renderEquipment();
                    break;
                case 'payments':
                    if (isLoggedIn) renderPayments();
                    break;
                case 'songs-library':
                    if (isLoggedIn) renderSongsLibrary();
                    break;
                case 'important-links':
                    if (isLoggedIn) renderImportantLinks();
                    break;
            }
        }

        function applyFilters() {
            const packageValue = packageFilter.value;
            const keyboardistValue = keyboardistFilter.value;
            const drummersValue = drummersFilter.value;

            filteredEvents = events.filter(event => {
                let matches = true;

                if (packageValue && event.package !== packageValue) {
                    matches = false;
                }

                if (keyboardistValue !== '') {
                    const hasKeyboardist = keyboardistValue === 'true';
                    if (event.keyboardist !== hasKeyboardist) {
                        matches = false;
                    }
                }

                if (drummersValue !== '') {
                    const hasDrummers = drummersValue === 'true';
                    if ((event.drummers > 0) !== hasDrummers) {
                        matches = false;
                    }
                }

                return matches;
            });

            renderEvents();
        }

        function renderEvents() {
            eventsContainer.innerHTML = filteredEvents.map((event, index) => {
                const eventDate = new Date(event.date);
                const formattedDate = eventDate.toLocaleDateString('he-IL', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });

                const statusColors = {
                    'confirmed': 'bg-green-500',
                    'pending': 'bg-yellow-500'
                };

                const gradientClass = `card-gradient-${(index % 6) + 1}`;

                return `
                    <div class="bg-white border border-gray-200 rounded-3xl shadow-lg hover:shadow-xl transition-all duration-300 cursor-pointer overflow-hidden" onclick="openEventModal(${event.id})">
                        <div class="${gradientClass} p-4 text-white">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
                                <div class="flex items-center mb-2 sm:mb-0">
                                    <span class="status-indicator ${statusColors[event.status]} ml-3 bg-white bg-opacity-80"></span>
                                    <h3 class="text-lg sm:text-xl font-bold">בר מצווה - ${event.name}</h3>
                                </div>
                                ${event.isStudent ? '<span class="bg-white bg-opacity-20 text-white px-3 py-1 rounded-full text-xs font-medium self-start sm:self-center">תלמיד פרטי</span>' : ''}
                            </div>
                        </div>

                        <div class="p-4 sm:p-5">
                            <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center">
                                <div class="flex-1 mb-4 lg:mb-0">
                                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 text-gray-600">
                                        <div class="bg-blue-50 p-3 rounded-2xl border border-blue-200 cursor-pointer hover:bg-blue-100 transition-colors" onclick="event.stopPropagation(); addToGoogleCalendar(${event.id})">
                                            <div class="flex items-center">
                                                <span class="text-blue-600 ml-2 text-lg">📅</span>
                                                <div class="flex flex-col">
                                                    <span class="text-xs text-blue-600 font-medium">תאריך</span>
                                                    <span class="font-bold text-blue-800 text-sm">${formattedDate}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="bg-green-50 p-3 rounded-2xl border border-green-200">
                                            <div class="flex items-center">
                                                <span class="text-green-600 ml-2 text-lg">👥</span>
                                                <div class="flex flex-col">
                                                    <span class="text-xs text-green-600 font-medium">הגעת אורחים</span>
                                                    <span class="font-bold text-green-800 text-sm">${event.guestArrivalTime || event.time}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="bg-orange-50 p-3 rounded-2xl border border-orange-200">
                                            <div class="flex items-center">
                                                <span class="text-orange-600 ml-2 text-lg">🎉</span>
                                                <div class="flex flex-col">
                                                    <span class="text-xs text-orange-600 font-medium">תחילת אירוע</span>
                                                    <span class="font-bold text-orange-800 text-sm">${event.eventStartTime || event.time}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="bg-purple-50 p-3 rounded-2xl border border-purple-200 cursor-pointer hover:bg-purple-100 transition-colors" onclick="event.stopPropagation(); openWaze('${event.wazeLink}')">
                                            <div class="flex items-start">
                                                <span class="text-purple-600 ml-2 text-lg flex-shrink-0">📍</span>
                                                <div class="flex flex-col flex-1 min-w-0">
                                                    <span class="text-xs text-purple-600 font-medium">מיקום</span>
                                                    <span class="font-bold text-purple-800 text-sm text-right break-words leading-tight">
                                                        ${event.location}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-3 sm:space-x-reverse">
                                    ${isLoggedIn ? `
                                        <div class="flex space-x-2 space-x-reverse">
                                            <button onclick="event.stopPropagation(); openYeshInvoice()" class="bg-blue-600 text-white px-3 py-2 rounded-2xl text-sm hover:bg-blue-700 transition-colors font-medium flex items-center">
                                                <span class="ml-1">🧾</span>
                                                <span>יש חשבונית</span>
                                            </button>
                                            <button onclick="event.stopPropagation(); sendWhatsAppToParent('${event.parentPhone}', '${event.parentName}', '${event.name}')" class="bg-green-600 text-white px-3 py-2 rounded-2xl text-sm hover:bg-green-700 transition-colors font-medium flex items-center">
                                                <span class="ml-1">📱</span>
                                                <span>WhatsApp</span>
                                            </button>
                                        </div>
                                    ` : ''}
                                    <div class="flex items-center text-blue-600 hover:text-blue-800 font-medium text-sm bg-blue-50 px-3 py-2 rounded-2xl hover:bg-blue-100 transition-colors">
                                        <span>פרטים נוספים</span>
                                        <span class="mr-2">←</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPrayerSongs() {
            const container = document.getElementById('prayerSongsContainer');
            
            // Add view toggle buttons
            const viewToggleHTML = `
                <div class="mb-6 flex justify-center">
                    <div class="bg-white rounded-2xl p-1 shadow-sm border border-gray-200">
                        <button id="prayerCategoriesBtn" onclick="togglePrayerView('categories')" class="px-4 py-2 rounded-xl text-sm font-medium transition-colors ${showPrayerCategories ? 'bg-purple-600 text-white' : 'text-gray-600 hover:bg-gray-100'}">
                            📂 קטגוריות
                        </button>
                        <button id="prayerListBtn" onclick="togglePrayerView('list')" class="px-4 py-2 rounded-xl text-sm font-medium transition-colors ${!showPrayerCategories ? 'bg-purple-600 text-white' : 'text-gray-600 hover:bg-gray-100'}">
                            📋 רשימה
                        </button>
                    </div>
                </div>
            `;
            
            if (showPrayerCategories) {
                renderPrayerSongsWithCategories(container, viewToggleHTML);
            } else {
                renderPrayerSongsAsList(container, viewToggleHTML);
            }
        }

        function renderPrayerSongsWithCategories(container, viewToggleHTML) {
            const categories = {};
            prayerSongs.forEach(song => {
                const category = song.category || 'כללי';
                if (!categories[category]) {
                    categories[category] = [];
                }
                categories[category].push(song);
            });

            const categoryOrder = ['כניסה', 'תפילה', 'הוצאת ספר תורה', 'ברכות', 'כללי'];
            
            container.innerHTML = viewToggleHTML + `
                <div class="space-y-6">
                    ${categoryOrder.filter(cat => categories[cat]).map(category => `
                        <div class="bg-purple-50 rounded-3xl p-6 border border-purple-200">
                            <h3 class="text-xl font-bold text-purple-800 mb-4 flex items-center">
                                <span class="w-4 h-4 bg-purple-500 rounded-full ml-3"></span>
                                ${category} (${categories[category].length})
                            </h3>
                            <div class="grid grid-cols-1 gap-4">
                                ${categories[category].map(song => renderPrayerSongCard(song)).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderPrayerSongsAsList(container, viewToggleHTML) {
            container.innerHTML = viewToggleHTML + `
                <div class="space-y-4">
                    ${prayerSongs.map(song => renderPrayerSongCard(song)).join('')}
                </div>
            `;
        }

        function renderPrayerSongCard(song) {
            const titleFontSize = song.name.length > 15 ? 'text-base' : song.name.length > 10 ? 'text-lg' : 'text-xl';
            
            return `
                <div class="song-card rounded-3xl shadow-sm hover:shadow-md transition-all overflow-hidden">
                    <div class="p-4 cursor-pointer hover:bg-gray-50 transition-colors" onclick="toggleSongDetails('prayer-${song.id}')">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center flex-1 min-w-0">
                                <span class="text-blue-600 ml-3 text-lg flex-shrink-0">🎵</span>
                                <h3 class="${titleFontSize} font-bold text-gray-800 truncate">${song.name}</h3>
                            </div>
                            <div class="flex items-center space-x-2 space-x-reverse flex-shrink-0">
                                <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs font-medium">${song.key}</span>
                                <span class="text-gray-400 text-xl" id="prayer-${song.id}-arrow">▼</span>
                            </div>
                        </div>
                    </div>
                    <div id="prayer-${song.id}-details" class="hidden border-t border-gray-200 p-4 bg-gray-50">
                        <div class="flex space-x-2 space-x-reverse mb-4">
                            <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-medium">${song.key}</span>
                            <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium">${song.tempo} BPM</span>
                            ${song.transpose !== 0 ? `<span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm font-medium">${song.transpose > 0 ? '+' : ''}${song.transpose}</span>` : ''}
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-2">אקורדים:</h4>
                                <p class="text-gray-600 bg-white p-3 rounded-2xl font-mono border">${song.chords}</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-2">מילים:</h4>
                                <p class="text-gray-600 bg-white p-3 rounded-2xl whitespace-pre-line border">${song.lyrics}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMealSongs() {
            const container = document.getElementById('mealSongsContainer');
            
            // Add view toggle buttons
            const viewToggleHTML = `
                <div class="mb-6 flex justify-center">
                    <div class="bg-white rounded-2xl p-1 shadow-sm border border-gray-200">
                        <button id="mealCategoriesBtn" onclick="toggleMealView('categories')" class="px-4 py-2 rounded-xl text-sm font-medium transition-colors ${showMealCategories ? 'bg-green-600 text-white' : 'text-gray-600 hover:bg-gray-100'}">
                            📂 קטגוריות
                        </button>
                        <button id="mealListBtn" onclick="toggleMealView('list')" class="px-4 py-2 rounded-xl text-sm font-medium transition-colors ${!showMealCategories ? 'bg-green-600 text-white' : 'text-gray-600 hover:bg-gray-100'}">
                            📋 רשימה
                        </button>
                    </div>
                </div>
            `;
            
            if (showMealCategories) {
                renderMealSongsWithCategories(container, viewToggleHTML);
            } else {
                renderMealSongsAsList(container, viewToggleHTML);
            }
        }

        function renderMealSongsWithCategories(container, viewToggleHTML) {
            const categories = {};
            mealSongs.forEach(song => {
                const category = song.category || 'כללי';
                if (!categories[category]) {
                    categories[category] = [];
                }
                categories[category].push(song);
            });

            const categoryOrder = ['סעודה', 'ברכות', 'הבדלה', 'כללי'];
            
            container.innerHTML = viewToggleHTML + `
                <div class="space-y-6">
                    ${categoryOrder.filter(cat => categories[cat]).map(category => `
                        <div class="bg-green-50 rounded-3xl p-6 border border-green-200">
                            <h3 class="text-xl font-bold text-green-800 mb-4 flex items-center">
                                <span class="w-4 h-4 bg-green-500 rounded-full ml-3"></span>
                                ${category} (${categories[category].length})
                            </h3>
                            <div class="grid grid-cols-1 gap-4">
                                ${categories[category].map(song => renderMealSongCard(song)).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderMealSongsAsList(container, viewToggleHTML) {
            container.innerHTML = viewToggleHTML + `
                <div class="space-y-4">
                    ${mealSongs.map(song => renderMealSongCard(song)).join('')}
                </div>
            `;
        }

        function renderMealSongCard(song) {
            const titleFontSize = song.name.length > 15 ? 'text-base' : song.name.length > 10 ? 'text-lg' : 'text-xl';
            
            return `
                <div class="song-card rounded-3xl shadow-sm hover:shadow-md transition-all overflow-hidden">
                    <div class="p-4 cursor-pointer hover:bg-gray-50 transition-colors" onclick="toggleSongDetails('meal-${song.id}')">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center flex-1 min-w-0">
                                <span class="text-green-600 ml-3 text-lg flex-shrink-0">🍽️</span>
                                <h3 class="${titleFontSize} font-bold text-gray-800 truncate">${song.name}</h3>
                            </div>
                            <div class="flex items-center space-x-2 space-x-reverse flex-shrink-0">
                                <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs font-medium">${song.key}</span>
                                <span class="text-gray-400 text-xl" id="meal-${song.id}-arrow">▼</span>
                            </div>
                        </div>
                    </div>
                    <div id="meal-${song.id}-details" class="hidden border-t border-gray-200 p-4 bg-gray-50">
                        <div class="flex space-x-2 space-x-reverse mb-4">
                            <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-medium">${song.key}</span>
                            <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium">${song.tempo} BPM</span>
                            ${song.transpose !== 0 ? `<span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm font-medium">${song.transpose > 0 ? '+' : ''}${song.transpose}</span>` : ''}
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-2">אקורדים:</h4>
                                <p class="text-gray-600 bg-white p-3 rounded-2xl font-mono border">${song.chords}</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-2">מילים:</h4>
                                <p class="text-gray-600 bg-white p-3 rounded-2xl whitespace-pre-line border">${song.lyrics}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStudents() {
            if (!isLoggedIn) return;
            
            studentsContainer.innerHTML = students.map(student => {
                const progressPercentage = (student.lessonsCompleted / student.totalLessons) * 100;
                
                return `
                    <div class="p-6 hover:bg-gray-50 transition-colors border-b border-gray-100 last:border-b-0">
                        <div class="flex flex-col lg:flex-row lg:justify-between lg:items-start gap-6">
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-xl font-bold text-gray-800">${student.name}</h3>
                                    <span class="px-3 py-1 rounded-full text-sm font-medium ${student.hasRecording ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">
                                        ${student.hasRecording ? '🎤 יש הקלטה' : '⏳ ללא הקלטה'}
                                    </span>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div class="bg-blue-50 p-3 rounded-2xl border border-blue-200">
                                        <div class="text-sm text-blue-600 font-medium mb-1">תאריכים חשובים</div>
                                        <div class="text-blue-800">
                                            <div><span class="font-medium">בר מצווה:</span> ${new Date(student.eventDate).toLocaleDateString('he-IL')}</div>
                                            <div><span class="font-medium">שיעור הבא:</span> ${new Date(student.nextLesson).toLocaleDateString('he-IL')}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-purple-50 p-3 rounded-2xl border border-purple-200">
                                        <div class="text-sm text-purple-600 font-medium mb-1">פרטי קריאה</div>
                                        <div class="text-purple-800">
                                            <div><span class="font-medium">פרשה:</span> ${student.parsha}</div>
                                            <div><span class="font-medium">סוג קריאה:</span> ${student.readingType}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-l from-amber-50 to-yellow-50 p-4 rounded-2xl border border-amber-200 mb-4">
                                    <h4 class="text-amber-800 font-semibold mb-3 flex items-center">
                                        <span class="ml-2">📜</span>
                                        פרטי קריאה בתורה
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                        <div>
                                            <span class="font-medium text-amber-700">קטע בתורה:</span>
                                            <div class="text-amber-800 bg-amber-100 p-2 rounded-lg mt-1">${student.torahPortion}</div>
                                        </div>
                                        <div>
                                            <span class="font-medium text-amber-700">הפטרה:</span>
                                            <div class="text-amber-800 bg-amber-100 p-2 rounded-lg mt-1">${student.haftarah}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-medium text-gray-700">התקדמות בלימודים</span>
                                        <span class="text-sm text-gray-600">${student.lessonsCompleted}/${student.totalLessons} שיעורים</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-3">
                                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-300" style="width: ${progressPercentage}%"></div>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">${Math.round(progressPercentage)}% הושלם</div>
                                </div>
                                
                                <div class="bg-gray-50 p-4 rounded-2xl mb-4">
                                    <h4 class="font-semibold text-gray-700 mb-2">התקדמות כללית:</h4>
                                    <p class="text-gray-700 text-sm">${student.progress}</p>
                                </div>
                                
                                <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-200">
                                    <h4 class="font-semibold text-indigo-700 mb-2">הערות מיוחדות:</h4>
                                    <p class="text-indigo-800 text-sm">${student.specialNotes}</p>
                                </div>
                            </div>
                            
                            <div class="lg:w-80">
                                <div class="bg-white border border-gray-200 rounded-2xl p-4 shadow-sm">
                                    <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                        <span class="ml-2">🎤</span>
                                        מצב הקלטה
                                    </h4>
                                    
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between p-3 rounded-xl ${student.hasRecording ? 'bg-green-50 border border-green-200' : 'bg-orange-50 border border-orange-200'}">
                                            <span class="font-medium ${student.hasRecording ? 'text-green-700' : 'text-orange-700'}">
                                                ${student.hasRecording ? 'הקלטה קיימת' : 'ללא הקלטה'}
                                            </span>
                                            <span class="text-2xl">${student.hasRecording ? '✅' : '❌'}</span>
                                        </div>
                                        
                                        <div class="bg-gray-50 p-3 rounded-xl">
                                            <div class="text-sm text-gray-600 font-medium mb-1">הערות הקלטה:</div>
                                            <div class="text-gray-700 text-sm">${student.recordingNotes}</div>
                                        </div>
                                        
                                        <div class="flex flex-col space-y-2">
                                            <button onclick="sendWhatsAppToStudent('${student.phone}', '${student.name}')" class="w-full bg-green-600 text-white px-4 py-2 rounded-xl hover:bg-green-700 transition-colors text-sm font-medium">
                                                📱 WhatsApp לתלמיד
                                            </button>
                                            
                                            <button onclick="toggleRecording(${student.id})" class="w-full px-4 py-2 rounded-xl text-sm font-medium transition-colors ${student.hasRecording ? 'bg-orange-600 text-white hover:bg-orange-700' : 'bg-blue-600 text-white hover:bg-blue-700'}">
                                                ${student.hasRecording ? '🗑️ מחק הקלטה' : '🎤 הוסף הקלטה'}
                                            </button>
                                            
                                            <button onclick="editStudent(${student.id})" class="w-full bg-gray-600 text-white px-4 py-2 rounded-xl hover:bg-gray-700 transition-colors text-sm font-medium">
                                                ✏️ ערוך פרטים
                                            </button>
                                            
                                            <button onclick="viewStudentProgress(${student.id})" class="w-full bg-purple-600 text-white px-4 py-2 rounded-xl hover:bg-purple-700 transition-colors text-sm font-medium">
                                                📊 יומן שיעורים
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderEquipment() {
            const container = document.getElementById('equipmentContainer');
            const categories = [...new Set(equipment.map(item => item.category))];
            
            container.innerHTML = categories.map(category => {
                const categoryItems = equipment.filter(item => item.category === category);
                return `
                    <div class="mb-8">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <span class="w-3 h-3 bg-blue-500 rounded-full ml-2"></span>
                            ${category}
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            ${categoryItems.map(item => `
                                <div class="flex items-center p-4 bg-gray-50 rounded-2xl hover:bg-gray-100 transition-colors">
                                    <input type="checkbox" id="equipment-${item.id}" ${item.checked ? 'checked' : ''} 
                                           onchange="toggleEquipment(${item.id})"
                                           class="w-5 h-5 text-blue-600 rounded-lg focus:ring-blue-500 ml-3">
                                    <label for="equipment-${item.id}" class="flex-1 font-medium text-gray-700 cursor-pointer">
                                        ${item.item}
                                    </label>
                                    <span class="text-2xl">${item.checked ? '✅' : '⭕'}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPayments() {
            const container = document.getElementById('paymentsContainer');
            container.innerHTML = payments.map(payment => `
                <div class="bg-gray-50 p-6 rounded-3xl mb-4 hover:bg-gray-100 transition-colors">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">אירוע: ${payment.eventName}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="p-4 bg-white rounded-2xl">
                            <div class="flex items-center justify-between mb-3">
                                <span class="font-medium text-gray-700">תשלום לקלידן</span>
                                <div class="flex items-center">
                                    <span class="text-2xl ml-2">${payment.keyboardistPaid ? '✅' : '❌'}</span>
                                    <button onclick="togglePayment(${payment.id}, 'keyboardist')" 
                                            class="px-3 py-1 rounded-full text-sm font-medium transition-colors ${payment.keyboardistPaid ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                        ${payment.keyboardistPaid ? 'שולם' : 'לא שולם'}
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600">סכום:</span>
                                <div class="flex items-center">
                                    <input type="number" value="${payment.keyboardistAmount || 0}" 
                                           onchange="updatePaymentAmount(${payment.id}, 'keyboardist', this.value)"
                                           class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-sm text-center">
                                    <span class="text-sm text-gray-600 mr-1">₪</span>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 bg-white rounded-2xl">
                            <div class="flex items-center justify-between mb-3">
                                <span class="font-medium text-gray-700">תשלום למתופפים</span>
                                <div class="flex items-center">
                                    <span class="text-2xl ml-2">${payment.drummersPaid ? '✅' : '❌'}</span>
                                    <button onclick="togglePayment(${payment.id}, 'drummers')" 
                                            class="px-3 py-1 rounded-full text-sm font-medium transition-colors ${payment.drummersPaid ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                        ${payment.drummersPaid ? 'שולם' : 'לא שולם'}
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600">סכום:</span>
                                <div class="flex items-center">
                                    <input type="number" value="${payment.drummersAmount || 0}" 
                                           onchange="updatePaymentAmount(${payment.id}, 'drummers', this.value)"
                                           class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-sm text-center">
                                    <span class="text-sm text-gray-600 mr-1">₪</span>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 bg-white rounded-2xl">
                            <div class="flex items-center justify-between mb-3">
                                <span class="font-medium text-gray-700">תשלום למנהלת</span>
                                <div class="flex items-center">
                                    <span class="text-2xl ml-2">${payment.managerPaid ? '✅' : '❌'}</span>
                                    <button onclick="togglePayment(${payment.id}, 'manager')" 
                                            class="px-3 py-1 rounded-full text-sm font-medium transition-colors ${payment.managerPaid ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                        ${payment.managerPaid ? 'שולם' : 'לא שולם'}
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600">סכום:</span>
                                <div class="flex items-center">
                                    <input type="number" value="${payment.managerAmount || 0}" 
                                           onchange="updatePaymentAmount(${payment.id}, 'manager', this.value)"
                                           class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-sm text-center">
                                    <span class="text-sm text-gray-600 mr-1">₪</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-white rounded-2xl">
                            <span class="font-medium text-gray-700">קבלה הוצאה</span>
                            <div class="flex items-center">
                                <span class="text-2xl ml-2">${payment.receiptIssued ? '✅' : '❌'}</span>
                                <button onclick="togglePayment(${payment.id}, 'receipt')" 
                                        class="px-3 py-1 rounded-full text-sm font-medium transition-colors ${payment.receiptIssued ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                    ${payment.receiptIssued ? 'הוצאה' : 'לא הוצאה'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderSongsLibrary() {
            const libraryContainer = document.getElementById('songsLibraryContainer');
            
            const allSongs = [
                ...prayerSongs.map(song => ({...song, source: 'prayer'})),
                ...mealSongs.map(song => ({...song, source: 'meal'})),
                ...songsLibrary.filter(song => !prayerSongs.find(p => p.id === song.id) && !mealSongs.find(m => m.id === song.id))
            ];

            const searchTerm = document.getElementById('songSearch')?.value.toLowerCase() || '';
            const filteredSongs = allSongs.filter(song => 
                song.name.toLowerCase().includes(searchTerm) ||
                (song.category && song.category.toLowerCase().includes(searchTerm)) ||
                song.lyrics.toLowerCase().includes(searchTerm)
            );

            if (showCategories) {
                renderSongsWithCategories(filteredSongs, libraryContainer);
            } else {
                renderSongsAsList(filteredSongs, libraryContainer);
            }
        }

        function renderSongsWithCategories(songs, container) {
            const categories = {};
            songs.forEach(song => {
                const category = song.category || 'ללא קטגוריה';
                if (!categories[category]) {
                    categories[category] = [];
                }
                categories[category].push(song);
            });

            const categoryOrder = ['כניסה', 'תפילה', 'הוצאת ספר תורה', 'ברכות', 'סעודה', 'הבדלה', 'ללא קטגוריה'];
            
            container.innerHTML = `
                <div class="space-y-6">
                    ${categoryOrder.filter(cat => categories[cat]).map(category => `
                        <div class="bg-gray-50 rounded-3xl p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                <span class="w-4 h-4 bg-blue-500 rounded-full ml-3"></span>
                                ${category} (${categories[category].length})
                            </h3>
                            <div class="grid grid-cols-1 gap-4">
                                ${categories[category].map(song => renderSongCard(song)).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderSongsAsList(songs, container) {
            container.innerHTML = `
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-bold text-gray-800">כל השירים (${songs.length})</h3>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-4">
                        ${songs.map(song => renderSongCard(song)).join('')}
                    </div>
                </div>
            `;
        }

        function renderSongCard(song) {
            return `
                <div class="song-card p-4 rounded-2xl shadow-sm hover:shadow-md transition-all bg-white">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="text-lg font-bold text-gray-800">${song.name}</h4>
                            <div class="flex items-center space-x-2 space-x-reverse mt-1">
                                ${song.category ? `<span class="bg-purple-100 text-purple-700 px-2 py-1 rounded-full text-xs font-medium">${song.category}</span>` : ''}
                                <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs font-medium">${song.key}</span>
                                <span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-medium">${song.tempo} BPM</span>
                                ${song.transpose !== 0 ? `<span class="bg-orange-100 text-orange-700 px-2 py-1 rounded-full text-xs font-medium">${song.transpose > 0 ? '+' : ''}${song.transpose}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex space-x-2 space-x-reverse">
                            ${song.youtubeLink ? `
                                <button onclick="window.open('${song.youtubeLink}', '_blank')" class="bg-red-600 text-white px-3 py-1 rounded-xl text-sm hover:bg-red-700">
                                    📺 YouTube
                                </button>
                            ` : ''}
                            <button onclick="editSong(${song.id})" class="bg-blue-600 text-white px-3 py-1 rounded-xl text-sm hover:bg-blue-700">
                                ✏️ ערוך
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                        <div>
                            <span class="font-medium text-gray-700">אקורדים:</span>
                            <div class="bg-gray-100 p-2 rounded-lg font-mono mt-1">${song.chords}</div>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">מילים:</span>
                            <div class="bg-gray-100 p-2 rounded-lg mt-1 max-h-20 overflow-y-auto whitespace-pre-line">${song.lyrics}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleCategories() {
            showCategories = !showCategories;
            const btn = document.getElementById('toggleCategoriesBtn');
            
            if (showCategories) {
                btn.textContent = '📋 הצג רשימה';
                btn.className = btn.className.replace('bg-purple-600', 'bg-orange-600').replace('hover:bg-purple-700', 'hover:bg-orange-700');
            } else {
                btn.textContent = '📂 הצג קטגוריות';
                btn.className = btn.className.replace('bg-orange-600', 'bg-purple-600').replace('hover:bg-orange-700', 'hover:bg-purple-700');
            }
            
            renderSongsLibrary();
        }

        function togglePrayerView(view) {
            showPrayerCategories = (view === 'categories');
            renderPrayerSongs();
        }

        function toggleMealView(view) {
            showMealCategories = (view === 'categories');
            renderMealSongs();
        }

        async function toggleEquipment(id) {
            const item = equipment.find(e => e.id === id);
            if (item) {
                item.checked = !item.checked;
                renderEquipment();
                await saveDataToCMS();
            }
        }

        async function togglePayment(id, type) {
            const payment = payments.find(p => p.id === id);
            if (payment) {
                switch(type) {
                    case 'keyboardist':
                        payment.keyboardistPaid = !payment.keyboardistPaid;
                        break;
                    case 'drummers':
                        payment.drummersPaid = !payment.drummersPaid;
                        break;
                    case 'manager':
                        payment.managerPaid = !payment.managerPaid;
                        break;
                    case 'receipt':
                        payment.receiptIssued = !payment.receiptIssued;
                        break;
                }
                renderPayments();
                await saveDataToCMS();
            }
        }

        function toggleRecording(studentId) {
            const student = students.find(s => s.id === studentId);
            if (student) {
                student.hasRecording = !student.hasRecording;
                if (student.hasRecording) {
                    student.recordingNotes = "הקלטה חדשה נוספה";
                } else {
                    student.recordingNotes = "הקלטה הוסרה";
                }
                renderStudents();
            }
        }

        function editStudent(studentId) {
            alert(`עריכת תלמיד ${studentId} - פונקציה זו תפותח בהמשך`);
        }

        function viewStudentProgress(studentId) {
            const student = students.find(s => s.id === studentId);
            if (student) {
                alert(`יומן שיעורים של ${student.name}:\n\nהושלמו: ${student.lessonsCompleted}/${student.totalLessons} שיעורים\nהתקדמות: ${student.progress}`);
            }
        }

        function editSong(songId) {
            alert(`עריכת שיר ${songId} - פונקציה זו תפותח בהמשך`);
        }

        function toggleSongDetails(songId) {
            const details = document.getElementById(`${songId}-details`);
            const arrow = document.getElementById(`${songId}-arrow`);
            
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                arrow.textContent = '▲';
            } else {
                details.classList.add('hidden');
                arrow.textContent = '▼';
            }
        }

        function editMediaLinks(eventId) {
            const event = events.find(e => e.id === eventId);
            if (!event) return;
            
            const photosLink = prompt('קישור לתמונות:', event.mediaLinks?.photos || '');
            if (photosLink === null) return;
            
            const videosLink = prompt('קישור לסרטונים:', event.mediaLinks?.videos || '');
            if (videosLink === null) return;
            
            if (!event.mediaLinks) {
                event.mediaLinks = {};
            }
            
            event.mediaLinks.photos = photosLink;
            event.mediaLinks.videos = videosLink;
            
            openEventModal(eventId);
            saveDataToCMS();
            showNotification('קישורי מדיה עודכנו בהצלחה!', 'success');
        }

        function manageCategories() {
            let categoriesHTML = `
                <div class="space-y-4">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">ניהול קטגוריות שירים</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${songCategories.map(category => `
                            <div class="bg-${category.color}-50 border border-${category.color}-200 p-4 rounded-2xl">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <span class="text-2xl ml-3">${category.icon}</span>
                                        <span class="font-medium text-${category.color}-800">${category.name}</span>
                                    </div>
                                    <div class="flex space-x-2 space-x-reverse">
                                        <button onclick="editCategory(${category.id})" class="bg-blue-600 text-white px-2 py-1 rounded-lg text-xs hover:bg-blue-700">
                                            ✏️
                                        </button>
                                        <button onclick="deleteCategory(${category.id})" class="bg-red-600 text-white px-2 py-1 rounded-lg text-xs hover:bg-red-700">
                                            🗑️
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addNewCategory()" class="w-full bg-green-600 text-white px-4 py-3 rounded-2xl hover:bg-green-700 transition-colors font-medium">
                        ➕ הוסף קטגוריה חדשה
                    </button>
                </div>
            `;
            
            modalTitle.textContent = 'ניהול קטגוריות';
            modalContent.innerHTML = categoriesHTML;
            eventModal.classList.remove('hidden');
        }

        function editCategory(categoryId) {
            const category = songCategories.find(c => c.id === categoryId);
            if (!category) return;
            
            const newName = prompt('שם הקטגוריה:', category.name);
            if (newName && newName !== category.name) {
                category.name = newName;
                manageCategories();
                renderSongsLibrary();
                showNotification('קטגוריה עודכנה בהצלחה!', 'success');
            }
        }

        function deleteCategory(categoryId) {
            const category = songCategories.find(c => c.id === categoryId);
            if (!category) return;
            
            if (confirm(`האם אתה בטוח שברצונך למחוק את הקטגוריה "${category.name}"?`)) {
                const index = songCategories.findIndex(c => c.id === categoryId);
                songCategories.splice(index, 1);
                
                // Update songs that had this category
                songsLibrary.forEach(song => {
                    if (song.category === category.name) {
                        song.category = 'כללי';
                    }
                });
                
                manageCategories();
                renderSongsLibrary();
                showNotification('קטגוריה נמחקה בהצלחה!', 'success');
            }
        }

        function addNewCategory() {
            const name = prompt('שם הקטגוריה החדשה:');
            if (!name) return;
            
            const icon = prompt('אייקון לקטגוריה (אמוג\'י):', '🎵');
            if (!icon) return;
            
            const colors = ['blue', 'purple', 'green', 'orange', 'pink', 'indigo', 'teal', 'amber', 'red'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            const newCategory = {
                id: Math.max(...songCategories.map(c => c.id)) + 1,
                name: name,
                color: color,
                icon: icon
            };
            
            songCategories.push(newCategory);
            manageCategories();
            showNotification('קטגוריה חדשה נוספה בהצלחה!', 'success');
        }

        function addNewEvent() {
            const name = prompt('שם בר המצווה:');
            if (!name) return;
            
            const date = prompt('תאריך (YYYY-MM-DD):');
            if (!date) return;
            
            const time = prompt('שעה (HH:MM):');
            if (!time) return;
            
            const location = prompt('מיקום:');
            if (!location) return;
            
            const newEvent = {
                id: Math.max(...events.map(e => e.id)) + 1,
                name: name,
                date: date,
                time: time,
                guestArrivalTime: time,
                eventStartTime: time,
                location: location,
                wazeLink: `https://waze.com/ul?q=${encodeURIComponent(location)}`,
                package: "חבילה בסיסית",
                keyboardist: false,
                drummers: 0,
                isStudent: false,
                price: 2000,
                parentPhone: "",
                parentName: "",
                notes: "",
                status: "pending",
                mediaLinks: { photos: "", videos: "" }
            };
            
            events.push(newEvent);
            filteredEvents = [...events];
            renderEvents();
            alert('אירוע חדש נוסף בהצלחה!');
        }

        function addNewSong() {
            const name = prompt('שם השיר:');
            if (!name) return;
            
            const key = prompt('סולם:');
            if (!key) return;
            
            const newSong = {
                id: Math.max(...songsLibrary.map(s => s.id)) + 1,
                name: name,
                key: key,
                tempo: 120,
                transpose: 0,
                chords: "C - Am - F - G",
                lyrics: "מילות השיר...",
                category: "כללי"
            };
            
            songsLibrary.push(newSong);
            renderSongsLibrary();
            alert('שיר חדש נוסף בהצלחה!');
        }

        function renderImportantLinks() {
            const container = document.getElementById('importantLinksContainer');
            
            // Group links by category
            const categories = {};
            importantLinks.forEach(link => {
                const category = link.category || 'כללי';
                if (!categories[category]) {
                    categories[category] = [];
                }
                categories[category].push(link);
            });

            const categoryColors = {
                'כספים': 'bg-green-50 border-green-200 text-green-800',
                'ניהול זמן': 'bg-blue-50 border-blue-200 text-blue-800',
                'תקשורת': 'bg-purple-50 border-purple-200 text-purple-800',
                'כללי': 'bg-gray-50 border-gray-200 text-gray-800'
            };

            container.innerHTML = `
                <div class="space-y-6">
                    ${Object.keys(categories).map(category => `
                        <div class="${categoryColors[category] || categoryColors['כללי']} rounded-3xl p-6 border">
                            <h3 class="text-xl font-bold mb-4 flex items-center">
                                <span class="w-4 h-4 bg-current rounded-full ml-3 opacity-60"></span>
                                ${category} (${categories[category].length})
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${categories[category].map(link => `
                                    <div class="bg-white p-4 rounded-2xl shadow-sm hover:shadow-md transition-all border border-gray-100">
                                        <div class="flex items-start justify-between mb-3">
                                            <div class="flex items-center">
                                                <span class="text-2xl ml-3">${link.icon}</span>
                                                <h4 class="font-bold text-gray-800 text-sm">${link.name}</h4>
                                            </div>
                                            <div class="flex space-x-1 space-x-reverse">
                                                <button onclick="editLink(${link.id})" class="bg-blue-600 text-white px-2 py-1 rounded-lg text-xs hover:bg-blue-700 transition-colors">
                                                    ✏️
                                                </button>
                                                <button onclick="deleteLink(${link.id})" class="bg-red-600 text-white px-2 py-1 rounded-lg text-xs hover:bg-red-700 transition-colors">
                                                    🗑️
                                                </button>
                                            </div>
                                        </div>
                                        <p class="text-gray-600 text-xs mb-3">${link.description}</p>
                                        <button onclick="window.open('${link.url}', '_blank')" 
                                                class="w-full bg-cyan-600 text-white px-4 py-2 rounded-xl hover:bg-cyan-700 transition-colors font-medium text-sm flex items-center justify-center">
                                            <span class="ml-2">🔗</span>
                                            <span>פתח קישור</span>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function addNewLink() {
            const name = prompt('שם הקישור:');
            if (!name) return;
            
            const url = prompt('כתובת הקישור (URL):');
            if (!url) return;
            
            const description = prompt('תיאור הקישור:') || '';
            const category = prompt('קטגוריה (כספים/ניהול זמן/תקשורת/כללי):') || 'כללי';
            const icon = prompt('אייקון (אמוג\'י):') || '🔗';
            
            const newLink = {
                id: Math.max(...importantLinks.map(l => l.id)) + 1,
                name: name,
                url: url,
                description: description,
                category: category,
                icon: icon
            };
            
            importantLinks.push(newLink);
            renderImportantLinks();
            saveDataToCMS();
            showNotification('קישור חדש נוסף בהצלחה!', 'success');
        }

        function editLink(linkId) {
            const link = importantLinks.find(l => l.id === linkId);
            if (!link) return;
            
            const newName = prompt('שם הקישור:', link.name);
            if (newName === null) return;
            
            const newUrl = prompt('כתובת הקישור:', link.url);
            if (newUrl === null) return;
            
            const newDescription = prompt('תיאור הקישור:', link.description);
            if (newDescription === null) return;
            
            const newCategory = prompt('קטגוריה:', link.category);
            if (newCategory === null) return;
            
            const newIcon = prompt('אייקון:', link.icon);
            if (newIcon === null) return;
            
            link.name = newName;
            link.url = newUrl;
            link.description = newDescription;
            link.category = newCategory;
            link.icon = newIcon;
            
            renderImportantLinks();
            saveDataToCMS();
            showNotification('קישור עודכן בהצלחה!', 'success');
        }

        function deleteLink(linkId) {
            const link = importantLinks.find(l => l.id === linkId);
            if (!link) return;
            
            if (confirm(`האם אתה בטוח שברצונך למחוק את הקישור "${link.name}"?`)) {
                const index = importantLinks.findIndex(l => l.id === linkId);
                importantLinks.splice(index, 1);
                
                renderImportantLinks();
                saveDataToCMS();
                showNotification('קישור נמחק בהצלחה!', 'success');
            }
        }

        function updatePaymentAmount(paymentId, type, amount) {
            const payment = payments.find(p => p.id === paymentId);
            if (payment) {
                const numAmount = parseInt(amount) || 0;
                switch(type) {
                    case 'keyboardist':
                        payment.keyboardistAmount = numAmount;
                        break;
                    case 'drummers':
                        payment.drummersAmount = numAmount;
                        break;
                    case 'manager':
                        payment.managerAmount = numAmount;
                        break;
                }
                saveDataToCMS();
            }
        }

        function openEventModal(eventId) {
            const event = events.find(e => e.id === eventId);
            if (!event) return;

            modalTitle.textContent = `בר מצווה - ${event.name}`;
            
            const packageColors = {
                'חבילה בסיסית': 'bg-blue-50 text-blue-700 border-blue-200',
                'חבילה חגיגית': 'bg-purple-50 text-purple-700 border-purple-200',
                'חבילת הכל כלול': 'bg-amber-50 text-amber-700 border-amber-200'
            };

            const musicians = [];
            if (event.keyboardist) musicians.push('קלידן');
            if (event.drummers > 0) musicians.push(`${event.drummers} מתופפים`);
            const musicianText = musicians.length > 0 ? musicians.join(' + ') : 'ללא ליווי מוזיקלי';

            let modalHTML = `
                <div class="space-y-4 sm:space-y-6">
                    <div class="bg-gradient-to-l from-blue-50 to-indigo-50 p-4 sm:p-6 rounded-2xl sm:rounded-3xl border border-blue-100">
                        <h4 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4">פרטי האירוע</h4>
                        <div class="space-y-3 sm:space-y-0 sm:grid sm:grid-cols-1 md:grid-cols-3 sm:gap-4">
                            <div class="bg-blue-100 p-3 rounded-xl border border-blue-200 cursor-pointer hover:bg-blue-200 transition-colors" onclick="addToGoogleCalendar(${event.id})">
                                <div class="flex items-center">
                                    <span class="text-blue-600 ml-2 text-lg">📅</span>
                                    <div>
                                        <span class="font-medium text-blue-800 text-sm">תאריך:</span>
                                        <div class="text-blue-700 font-bold text-sm">${new Date(event.date).toLocaleDateString('he-IL', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-green-100 p-3 rounded-xl border border-green-200">
                                <div class="flex items-center">
                                    <span class="text-green-600 ml-2 text-lg">👥</span>
                                    <div>
                                        <span class="font-medium text-green-800 text-sm">הגעת אורחים:</span>
                                        <div class="text-green-700 font-bold text-sm">${event.guestArrivalTime || event.time}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-orange-100 p-3 rounded-xl border border-orange-200">
                                <div class="flex items-center">
                                    <span class="text-orange-600 ml-2 text-lg">🎉</span>
                                    <div>
                                        <span class="font-medium text-orange-800 text-sm">תחילת אירוע:</span>
                                        <div class="text-orange-700 font-bold text-sm">${event.eventStartTime || event.time}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-purple-100 p-3 rounded-xl border border-purple-200 md:col-span-3 cursor-pointer hover:bg-purple-200 transition-colors" onclick="openWaze('${event.wazeLink}')">
                                <div class="flex items-center">
                                    <span class="text-purple-600 ml-2 text-lg">📍</span>
                                    <div class="flex-1">
                                        <span class="font-medium text-purple-800 text-sm">מיקום:</span>
                                        <div class="flex items-center justify-between">
                                            <div class="text-purple-700 font-bold text-sm flex-1">${event.location}</div>
                                            ${isLoggedIn ? `
                                                <button onclick="event.stopPropagation(); editWazeLink(${event.id})" 
                                                        class="bg-orange-600 text-white px-2 py-1 rounded-lg text-xs hover:bg-orange-700 transition-colors">
                                                    ⚙️
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-4 sm:gap-6">
                        <div>
                            <h4 class="text-base sm:text-lg font-semibold text-gray-800 mb-2 sm:mb-3">חבילת השירות</h4>
                            <div class="inline-block px-3 sm:px-4 py-2 sm:py-3 rounded-xl sm:rounded-2xl border ${packageColors[event.package]} font-medium text-sm sm:text-base">
                                ${event.package}
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-base sm:text-lg font-semibold text-gray-800 mb-2 sm:mb-3">ליווי מוזיקלי</h4>
                            <div class="bg-gray-50 p-3 sm:p-4 rounded-xl sm:rounded-2xl">
                                <div class="flex items-center">
                                    <span class="text-orange-500 ml-2">🎵</span>
                                    <span class="text-gray-700 text-sm sm:text-base">${musicianText}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-4 sm:pt-6">
                        <div class="flex justify-between items-center mb-2 sm:mb-3">
                            <h4 class="text-base sm:text-lg font-semibold text-gray-800">תמונות וסרטונים מהאירוע</h4>
                            ${isLoggedIn ? `
                                <button onclick="editMediaLinks(${event.id})" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-blue-700 transition-colors">
                                    ✏️ ערוך קישורים
                                </button>
                            ` : ''}
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div class="bg-pink-50 p-3 sm:p-4 rounded-xl sm:rounded-2xl border border-pink-200 hover:bg-pink-100 transition-colors flex items-center ${event.mediaLinks?.photos ? 'cursor-pointer' : ''}" ${event.mediaLinks?.photos ? `onclick="window.open('${event.mediaLinks.photos}', '_blank')"` : ''}>
                                <span class="text-pink-600 ml-2 text-lg">📸</span>
                                <div>
                                    <div class="font-medium text-pink-800">תמונות מהאירוע</div>
                                    <div class="text-xs text-pink-600">${event.mediaLinks?.photos ? 'לחץ לצפייה' : 'אין קישור'}</div>
                                </div>
                            </div>
                            <div class="bg-indigo-50 p-3 sm:p-4 rounded-xl sm:rounded-2xl border border-indigo-200 hover:bg-indigo-100 transition-colors flex items-center ${event.mediaLinks?.videos ? 'cursor-pointer' : ''}" ${event.mediaLinks?.videos ? `onclick="window.open('${event.mediaLinks.videos}', '_blank')"` : ''}>
                                <span class="text-indigo-600 ml-2 text-lg">🎥</span>
                                <div>
                                    <div class="font-medium text-indigo-800">סרטונים מהאירוע</div>
                                    <div class="text-xs text-indigo-600">${event.mediaLinks?.videos ? 'לחץ לצפייה' : 'אין קישור'}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${isLoggedIn ? `
                        <div class="border-t border-gray-200 pt-4 sm:pt-6">
                            <div class="grid grid-cols-1 gap-4 sm:gap-6">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <h4 class="text-base sm:text-lg font-semibold text-gray-800 mb-2 sm:mb-3">פרטים פיננסיים</h4>
                                        <div class="bg-green-50 p-3 sm:p-4 rounded-xl sm:rounded-2xl border border-green-200">
                                            <div class="text-xl sm:text-2xl font-bold text-green-600">₪${event.price.toLocaleString()}</div>
                                            <div class="text-xs sm:text-sm text-gray-600">מחיר סופי</div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <h4 class="text-base sm:text-lg font-semibold text-gray-800 mb-2 sm:mb-3">פרטי קשר</h4>
                                        <div class="bg-gray-50 p-3 sm:p-4 rounded-xl sm:rounded-2xl space-y-2">
                                            <div class="text-sm"><span class="font-medium">הורה:</span> ${event.parentName}</div>
                                            <div class="text-sm"><span class="font-medium">טלפון:</span> ${event.parentPhone}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <h4 class="text-base sm:text-lg font-semibold text-gray-800 mb-2 sm:mb-3">הערות</h4>
                                    <div class="bg-yellow-50 p-3 sm:p-4 rounded-xl sm:rounded-2xl border border-yellow-200">
                                        <p class="text-gray-700 text-sm sm:text-base">${event.notes}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 sm:space-x-reverse mt-6 sm:mt-8 pt-4 sm:pt-6 border-t border-gray-200">
                    <button class="px-4 sm:px-6 py-2 bg-gray-200 text-gray-700 rounded-xl sm:rounded-2xl hover:bg-gray-300 transition-colors font-medium text-sm sm:text-base" onclick="document.getElementById('eventModal').classList.add('hidden')">
                        סגור
                    </button>
                    ${isLoggedIn ? `
                        <button onclick="openYeshInvoice()" class="px-4 sm:px-6 py-2 bg-blue-600 text-white rounded-xl sm:rounded-2xl hover:bg-blue-700 transition-colors font-medium text-sm sm:text-base flex items-center justify-center">
                            <span class="ml-2">🧾</span>
                            <span>יש חשבונית</span>
                        </button>
                        <button onclick="sendWhatsAppToParent('${event.parentPhone}', '${event.parentName}', '${event.name}')" class="px-4 sm:px-6 py-2 bg-green-600 text-white rounded-xl sm:rounded-2xl hover:bg-green-700 transition-colors font-medium text-sm sm:text-base flex items-center justify-center">
                            <span class="ml-2">📱</span>
                            <span>שלח WhatsApp</span>
                        </button>
                    ` : ''}
                </div>
            `;

            modalContent.innerHTML = modalHTML;
            eventModal.classList.remove('hidden');
        }

        function openWaze(wazeLink) {
            if (wazeLink) {
                window.open(wazeLink, '_blank');
            } else {
                alert('קישור Waze לא זמין לאירוע זה');
            }
        }

        function addToGoogleCalendar(eventId) {
            const event = events.find(e => e.id === eventId);
            if (!event) return;

            const eventDate = new Date(event.date);
            const [hours, minutes] = event.eventStartTime.split(':');
            eventDate.setHours(parseInt(hours), parseInt(minutes));
            
            const endDate = new Date(eventDate);
            endDate.setHours(endDate.getHours() + 3);

            const startTime = eventDate.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
            const endTime = endDate.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');

            const title = `בר מצווה - ${event.name}`;
            const details = `
בר מצווה: ${event.name}
חבילה: ${event.package}
מיקום: ${event.location}

⏰ זמנים:
👥 הגעת אורחים: ${event.guestArrivalTime}
🎉 תחילת אירוע: ${event.eventStartTime}

${event.keyboardist ? '🎹 עם קלידן' : ''}
${event.drummers > 0 ? `🥁 ${event.drummers} מתופפים` : ''}
${event.notes ? `\nהערות: ${event.notes}` : ''}
${isLoggedIn ? `\nהורה: ${event.parentName}\nטלפון: ${event.parentPhone}\nמחיר: ₪${event.price.toLocaleString()}` : ''}
            `.trim();

            const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startTime}/${endTime}&details=${encodeURIComponent(details)}&location=${encodeURIComponent(event.location)}&sf=true&output=xml`;

            window.open(googleCalendarUrl, '_blank');
        }

        function editWazeLink(eventId) {
            const event = events.find(e => e.id === eventId);
            if (event) {
                const newLink = prompt('הכנס קישור Waze חדש:', event.wazeLink);
                if (newLink !== null) {
                    event.wazeLink = newLink;
                    openEventModal(eventId);
                    alert('קישור Waze עודכן בהצלחה!');
                }
            }
        }

        function sendWhatsAppToParent(phone, parentName, studentName) {
            const message = `שלום ${parentName},\n\nבקשר לבר המצווה של ${studentName}.\n\nאשמח לתאם פרטים נוספים.\n\nבברכה,\nהמנהל`;
            const cleanPhone = phone.replace(/[^0-9]/g, '');
            const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function sendWhatsAppToStudent(phone, studentName) {
            const message = `שלום ${studentName},\n\nתזכורת לשיעור הקרוב.\n\nנתראה!`;
            const cleanPhone = phone.replace(/[^0-9]/g, '');
            const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        async function saveDataToCMS() {
            try {
                systemData.events = events;
                systemData.students = students;
                systemData.prayerSongs = prayerSongs;
                systemData.mealSongs = mealSongs;
                systemData.equipment = equipment;
                systemData.payments = payments;
                systemData.lessons = lessons;
                systemData.messageHistory = messageHistory;
                systemData.songsLibrary = songsLibrary;
                systemData.songCategories = songCategories;
                systemData.importantLinks = importantLinks;
                systemData.lastUpdated = new Date().toISOString();
                
                localStorage.setItem('barMitzvahData', JSON.stringify(systemData));
                
                console.log('נתונים נשמרו בהצלחה');
                return true;
            } catch (error) {
                console.error('שגיאה בשמירת נתונים:', error);
                return false;
            }
        }

        async function refreshDataFromCMS() {
            try {
                const savedData = localStorage.getItem('barMitzvahData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    
                    events.length = 0;
                    events.push(...parsedData.events);
                    
                    students.length = 0;
                    students.push(...parsedData.students);
                    
                    prayerSongs.length = 0;
                    prayerSongs.push(...parsedData.prayerSongs);
                    
                    mealSongs.length = 0;
                    mealSongs.push(...parsedData.mealSongs);
                    
                    equipment.length = 0;
                    equipment.push(...parsedData.equipment);
                    
                    payments.length = 0;
                    payments.push(...parsedData.payments);
                    
                    if (parsedData.songCategories) {
                        songCategories.length = 0;
                        songCategories.push(...parsedData.songCategories);
                    }
                    
                    if (parsedData.importantLinks) {
                        importantLinks.length = 0;
                        importantLinks.push(...parsedData.importantLinks);
                    }
                    
                    filteredEvents = [...events];
                    renderCurrentPage();
                    
                    showNotification('נתונים רוענו בהצלחה!', 'success');
                } else {
                    showNotification('לא נמצאו נתונים שמורים', 'info');
                }
            } catch (error) {
                console.error('שגיאה ברענון נתונים:', error);
                showNotification('שגיאה ברענון נתונים', 'error');
            }
        }

        function exportToCMSFormat() {
            const dataToExport = {
                events: events,
                students: students,
                prayerSongs: prayerSongs,
                mealSongs: mealSongs,
                equipment: equipment,
                payments: payments,
                lessons: lessons,
                messageHistory: messageHistory,
                songsLibrary: songsLibrary,
                songCategories: songCategories,
                importantLinks: importantLinks,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `bar-mitzvah-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('נתונים יוצאו בהצלחה!', 'success');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-2xl shadow-lg max-w-sm transition-all duration-300 ${
                type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
                type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' :
                'bg-blue-100 text-blue-800 border border-blue-200'
            }`;
            
            notification.innerHTML = `
                <div class="flex items-center">
                    <span class="ml-2">${type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️'}</span>
                    <span class="font-medium">${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // PWA functionality
        let deferredPrompt;
        const installButton = document.getElementById('installApp');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.classList.remove('hidden');
        });

        installButton.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    showNotification('האפליקציה הותקנה בהצלחה!', 'success');
                }
                deferredPrompt = null;
                installButton.classList.add('hidden');
            }
        });

        // Generate PWA manifest dynamically
        const manifest = {
            name: "מערכת ניהול אירועי בר מצווה",
            short_name: "בר מצווה מנהל",
            description: "מערכת ניהול מקצועית לאירועי בר מצווה",
            start_url: "/",
            display: "standalone",
            background_color: "#1e3a8a",
            theme_color: "#1e3a8a",
            icons: [
                {
                    src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%231e3a8a'/><text y='50' x='50' text-anchor='middle' dominant-baseline='middle' font-size='40' fill='white'>🎵</text></svg>",
                    sizes: "192x192",
                    type: "image/svg+xml"
                },
                {
                    src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%231e3a8a'/><text y='50' x='50' text-anchor='middle' dominant-baseline='middle' font-size='40' fill='white'>🎵</text></svg>",
                    sizes: "512x512",
                    type: "image/svg+xml"
                }
            ]
        };

        document.getElementById('manifest').href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(manifest));

        // Check for Auth0 callback on page load
        async function handleAuth0Callback() {
            try {
                if (auth0Client && window.location.search.includes('code=')) {
                    console.log('מעבד callback של Auth0...');
                    
                    const result = await auth0Client.handleRedirectCallback();
                    
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    const user = await auth0Client.getUser();
                    
                    if (user) {
                        console.log('התחברות Auth0 הצליחה:', user);
                        login();
                        currentAuthProvider = 'auth0';
                        showNotification(`ברוך הבא ${user.name || user.email}!`, 'success');
                    }
                }
            } catch (error) {
                console.error('Auth0 callback error:', error);
                showNotification('שגיאה בהתחברות', 'error');
            }
        }

        // Initialize application
        async function initApp() {
            try {
                await initAuth0();
                await handleAuth0Callback();
                
                if (auth0Client) {
                    const isAuthenticated = await auth0Client.isAuthenticated();
                    if (isAuthenticated) {
                        const user = await auth0Client.getUser();
                        console.log('כבר מחובר עם Auth0:', user);
                        login();
                        currentAuthProvider = 'auth0';
                    }
                }
                
                await refreshDataFromCMS();
                renderCurrentPage();
                
                console.log('אפליקציה אותחלה בהצלחה');
                
            } catch (error) {
                console.error('שגיאה באתחול האפליקציה:', error);
                renderCurrentPage();
            }
        }

        // Auto-save data every 5 minutes
        setInterval(async () => {
            if (isLoggedIn) {
                await saveDataToCMS();
            }
        }, 5 * 60 * 1000);

        function openYeshInvoice() {
            window.open('https://www.yeshinvoice.co.il', '_blank');
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });

        // Add search functionality to songs library
        document.addEventListener('DOMContentLoaded', function() {
            const songSearch = document.getElementById('songSearch');
            if (songSearch) {
                songSearch.addEventListener('input', function() {
                    if (currentPage === 'songs-library') {
                        renderSongsLibrary();
                    }
                });
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'963a8a98c25394d7',t:'MTc1MzI2NzAzNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
